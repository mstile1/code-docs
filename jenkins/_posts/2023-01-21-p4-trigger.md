---
layout: post
title:  "Jenkins Perforce Trigger Troubleshooting"
author: Brad Fix
tags: network windows perforce
---

Setting this up has been more difficult than anticipated. Here are some notes and possible trouble shooting tips.

### How the system ultimately works:
1. A user submits a changelist to Perforce.
2. Perforce executes a trigger that you've set up to run a script
 - 'script' = batch command, exe, bash script... whatever you prefer
3. The script sends a json payload to the Jenkins endpoint
4. Jenkins authenticates and validates the payload
5. All 'Perforce Triggered Builds' are notified to poll Perforce and build if necessary.

### Jenkins Build Settings
1. You may want to have a dedicated user added to Perforce for Jenkins. This likely isn't necessary.
2. Add a credential in Jenkins to enable p4 access.
 - click on global->Add Credentials
 - Kind: Perforce Password Credential
 - ID, Description: e.g. 'p4_access'
 - **P4Port must match the final http post**
 - Username/Password: can use jenkins p4 user login (or user with checkout privileges)
  <img src="/code-docs/assets/jk_credential.jpg" alt="credentials"/>
3. In a build's configuration, choose these new credentials for 'Perforce Software->Perforce Credentials'.
4. Make sure 'Perforce Triggered Build' is checked under 'Build Triggers'

### Jenkins user authorization
1. API Token->'Add New Token' for an admin user.
  <img src="/code-docs/assets/jk_apitoken.jpg" alt="api token"/>
2. Copy the token generated, it will be needed for the curl request.

### Setting up the curl request
```batch
SET change=%1

SET p4port=mstile-home:1666
SET endpoint=http://mstile-home:8080/p4/change
SET user=bfix
SET token=4234kjkjapitoken42klj4k23j4l2

curl --request POST ^
    --user %user%:%token% ^
    --json "payload={\"change\":\"%change%\", \"p4port\":\"%p4port%\"}" ^
    %endpoint%
```
1. *change*: the changelist passed as an argument to the script by the p4 trigger
2. *p4port*: must be an exact match to the P4Port in the Jenkins credential
 - (just a string comparison)
3. *user*:*token*: are for the api token created in Jenkins
 - this will authenticate the request
4. *payload*: 'change' and 'p4port' fields are required
 - **Note: if Jenkins doesn't like the json formatting, there may be no error provided**